name: CI

on:
  push:
  pull_request:

jobs:
  tests:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - php: "8.3"
            symfony: "7.4.*"
            composer_flags: ""
            deprecations: "max[direct]=0"

          - php: "8.4"
            symfony: "7.4.*"
            composer_flags: ""
            deprecations: "max[direct]=0"

          # Symfony 8 requires PHP 8.4+
          - php: "8.4"
            symfony: "8.0.*"
            composer_flags: ""
            deprecations: "max[direct]=0"

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "${{ matrix.php }}"
          tools: composer:v2
          coverage: none

      - name: Validate composer.json
        run: composer validate --strict

      - name: Install Symfony Flex (for SYMFONY_REQUIRE)
        run: |
          composer global config --no-plugins allow-plugins.symfony/flex true
          composer global require --no-progress --no-scripts --no-plugins symfony/flex

      - name: Install dependencies
        env:
          SYMFONY_REQUIRE: "${{ matrix.symfony }}"
        run: |
          composer update --prefer-dist --no-progress ${{ matrix.composer_flags }}

      - name: PHPUnit
        env:
          SYMFONY_DEPRECATIONS_HELPER: "${{ matrix.deprecations }}"
        run: vendor/bin/phpunit

      - name: PHPStan
        run: vendor/bin/phpstan analyse -c phpstan.neon.dist --no-progress

      - name: CS Fixer (dry-run)
        run: vendor/bin/php-cs-fixer fix --dry-run --diff
